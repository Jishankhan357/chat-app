<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Real-Time Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Simple styles -->
  <style>
    * { box-sizing: border-box; font-family: system-ui, Arial, sans-serif; }
    body { background: #f6f7fb; margin: 0; padding: 20px; }
    .card {
      max-width: 720px; margin: 0 auto; background: #fff;
      border-radius: 14px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    h2 { margin: 4px 0 16px; text-align: center; }
    .join {
      display: flex; gap: 8px; justify-content: center; align-items: center; padding: 16px 0;
    }
    input[type="text"] {
      flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px;
    }
    button {
      padding: 12px 16px; border: 0; border-radius: 10px; cursor: pointer; background: #4f46e5; color: #fff;
    }
    button:disabled { background: #bdb9ff; cursor: not-allowed; }
    .messages {
      height: 360px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; padding: 12px; background: #fafbff;
    }
    .msg { margin-bottom: 10px; }
    .me   { text-align: right; }
    .bubble {
      display: inline-block; padding: 10px 12px; border-radius: 12px; background: #eaeaff;
      max-width: 85%; word-wrap: break-word;
    }
    .me .bubble { background: #d1fae5; }
    .meta { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .input-row { display: flex; gap: 8px; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="app" class="card">
    <h2>Real-Time Chat</h2>

    <!-- Step 1: Join -->
    <div v-if="!joined" class="join">
      <input type="text" v-model="username" placeholder="Type your name" />
      <button @click="join" :disabled="!username.trim()">Join Chat</button>
    </div>

    <!-- Step 2: Chat -->
    <div v-else>
      <div id="messages" class="messages">
        <div v-for="(m, i) in messages" :key="i" class="msg" :class="{ me: m.user === username }">
          <div class="bubble">
            <strong>{{ m.user }}</strong><br>
            {{ m.text }}
          </div>
          <div class="meta">{{ timeStr(m.time) }}</div>
        </div>
      </div>

      <div class="input-row">
        <input type="text" v-model="newMessage" @keyup.enter="send" placeholder="Type a message..." />
        <button @click="send">Send</button>
      </div>
    </div>
  </div>

  <!-- Vue 3 (CDN) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Socket.IO client served by our server (always matches the server version) -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const { createApp, ref, nextTick } = Vue;

    createApp({
      setup() {
        const joined     = ref(false);
        const username   = ref('');
        const newMessage = ref('');
        const messages   = ref([]);
        let socket = null;

        function scrollToBottom() {
          const box = document.getElementById('messages');
          if (box) box.scrollTop = box.scrollHeight;
        }

        function join() {
          username.value = username.value.trim() || 'Anonymous';
          joined.value = true;

          socket = io(); // connect to same server (http://localhost:3000)
          socket.on('initial messages', (msgs) => {
            messages.value = msgs;
            nextTick(scrollToBottom);
          });
          socket.on('chat message', (msg) => {
            messages.value.push(msg);
            nextTick(scrollToBottom);
          });
        }

        function send() {
          const text = newMessage.value.trim();
          if (!text || !socket) return;
          socket.emit('chat message', { user: username.value, text });
          newMessage.value = '';
        }

        function timeStr(t) {
          const d = new Date(t || Date.now());
          return d.toLocaleTimeString();
        }

        return { joined, username, newMessage, messages, join, send, timeStr };
      }
    }).mount('#app');
  </script>
</body>
</html>
